#!/bin/bash

#============================================================================
# Copyright 2009- ECMWF.
# This software is licensed under the terms of the Apache Licence version 2.0
# which can be obtained at http://www.apache.org/licenses/LICENSE-2.0.
# In applying this licence, ECMWF does not waive the privileges and immunities
# granted to it by virtue of its status as an intergovernmental organisation
# nor does it submit to any jurisdiction.
#============================================================================

set -e
set -x #goes to stderr

echo " arguments=$*" >&2

#if [[ $# -ne 7 ]] ; then
#    echo "Error: wrong number of arguments = $# (must be 7)" >&2
#    if [[ $# -eq 0 ]] ; then
#        echo "This script should only be called from within ecflow_ui." >&2
#    fi
#    exit 1
#fi

sourceFile=
remoteUid=${USER}
remoteHost=
targetFile=
proxyJump=
byteMode=
byteValue=

while getopts s:u:h:t:j:m:v: flag
do
    case "${flag}" in
        s) sourceFile=${OPTARG};;
        u) remoteUid=${OPTARG};;
        h) remoteHost=${OPTARG};;
        t) targetFile=${OPTARG};;
        j) proxyJump=${OPTARG};;
        m) byteMode=${OPTARG};;
        v) byteValue=${OPTARG};;
    esac
done

echo ""
echo "sourceFile=$sourceFile" >&2
echo "remoteUid=$remoteUid" >&2
echo "remoteHost=$remoteHost" >&2
echo "targetFile=$targetFile" >&2
echo "proxyJump=$proxyJump" >&2
echo "byteMode=$byteMode" >&2
echo "byteValue=$byteValue" >&2
echo "remoteUid=$remoteUid" >&2
echo ""

if [[ $sourceFile == "" ]] ; then
    echo "Error: sourceFile is empty!" >&2
    exit 1
fi

if [[ $remoteHost == "" ]] ; then
    echo "Error: remoteHost is empty!" >&2
    exit 1
fi

if [[ $targetFile == "" ]] ; then
    echo "Error: targetFile is empty!" >&2
    exit 1
fi

if [[ $proxyJump == "" ]] ; then
    echo "Error: proxyJump is empty!" >&2
    exit 1
elif [[ $proxyJump == "__NOJUMP__" ]] ; then
    proxyJump=""
else
    proxyJump="-J ${proxyJump}"
fi

if [[ $byteMode != "all" && $byteMode != "pos" &&  $byteMode != "last" ]] ; then
    echo "Error: invalid byteMode value! Allowed values are: \"all\", \"pos\" and \"last\"" >&2
    exit 1
fi

if [[ $byteValue == "" ]] ; then
    echo "Error: byteValue is empty!" >&2
    exit 1
fi

if [[ $byteValue -lt 0 ]] ; then
    echo "Error: byteValue (=${byteValue}) must be >=0!" >&2
    exit 1
fi

if [[ $remoteUid == "" ]] ; then
    echo "Error: remoteUid is empty!" >&2
    exit 1
fi

if [[ $remoteUid == "__USER__" ]]  ; then
    remoteUid=${USER}
fi

# transfer the whole file
if [[ $byteMode == "all" ]] ; then
    #script -q -c "scp ${host}:/${sourceFile} ${targetFile}"
    echo "scp ${proxyJump} ${remoteUid}@${remoteHost}:${sourceFile} ${targetFile}" >&2
    scp ${proxyJump} ${remoteUid}@${remoteHost}:${sourceFile} ${targetFile}

#transfer the last bytes of the file
else
    sourceSize=$(ssh ${remoteUid}@${remoteHost} -o StrictHostKeyChecking=no "wc -c < ${sourceFile}")

    if [[ ${sourceSize} -gt 0 && ${sourceSize} -le ${lastBytes} ]] ; then
        #script -q -c "scp ${host}:/${sourceFile} ${targetFile}"
        scp ${proxyJump} ${remoteHost}:/${sourceFile} ${targetFile}
    else
        ssh ${remoteUid}@${remoteHost} -o StrictHostKeyChecking=no "tail -c ${lastBytes} ${sourceFile}" > ${targetFile}
    fi
fi

